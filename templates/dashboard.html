<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Tomato AI</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
        }
        .sidebar {
            height: 100vh;
            background-color: #1e1e1e;
            padding: 20px;
            position: fixed;
            width: 240px;
        }
        .sidebar h3 {
            color: #fff;
            margin-bottom: 30px;
        }
        .sidebar a {
            color: #bdbdbd;
            display: block;
            padding: 12px;
            border-radius: 6px;
            text-decoration: none;
            margin-bottom: 10px;
            transition: 0.2s;
        }
        .sidebar a:hover {
            background-color: #333;
            color: #fff;
        }
        .logout-btn {
            background-color: #d32f2f;
            color: #fff !important;
        }
        .content {
            margin-left: 265px;
            padding: 20px;
        }
        .card-dark {
            background-color: #1e1e1e;
            border: 1px solid #333;
            color: #e0e0e0;
        }
        .upload-box {
            background-color: #1e1e1e;
            border: 2px dashed #333;
            border-radius: 10px;
            padding: 30px;
            cursor: pointer;
            text-align: center;
            color: #bdbdbd;
            transition: 0.3s;
        }
        .upload-box:hover {
            border-color: #6200ea;
            color: #fff;
        }
        table {
            color: #e0e0e0;
        }
        table thead {
            background-color: #2c2c2c;
        }
        audio {
            width: 150px;
        }
    </style>
</head>

<body>

<!-- Sidebar -->
<div class="sidebar">
    <h3>ðŸŒ¿ Tomato AI</h3>

    <a href="#" class="active">Dashboard</a>
    <a href="#" onclick="loadHistory(); scrollToHistory()">History</a>
    <a href="#" class="logout-btn mt-5" onclick="logout()">Logout</a>
</div>


<!-- Content -->
<div class="content">
    <h2>Welcome to Tomato Disease Detector</h2>
    <p>Upload a tomato leaf image to detect disease using AI.</p>

    <!-- Upload Box -->
    <div class="upload-box mt-4" onclick="document.getElementById('fileInput').click()">
        <h5>Click to Upload Image</h5>
        <p>Supported: JPG, PNG</p>
    </div>

    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="fileInput" name="file" class="d-none" onchange="submitForm()">
        <input type="hidden" id="userId">
        <input type="hidden" id="tokenField">
    </form>

    <!-- Results -->
    <div class="card card-dark mt-4 p-3" id="result" style="display:none;">
        <h4>Prediction Result</h4>
        <p id="predictionText"></p>
        <p id="adviceText"></p>
        <audio controls id="audioPlayer"></audio>
    </div>

    <!-- History -->
   <div id="historySection" class="card card-dark mt-5 p-3">

        <h4>My History</h4>
        <table class="table table-dark table-bordered mt-3">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Disease</th>
                    <th>Advice</th>
                    <th>Audio</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="historyTable"></tbody>
        </table>
    </div>

</div>


<script>
const userId = localStorage.getItem("user_id");
const token = localStorage.getItem("token");

document.getElementById("userId").value = userId;
document.getElementById("tokenField").value = token;

/* -----------------------
   Auto submit after pick
--------------------------*/
function submitForm() {
    document.getElementById("uploadForm").dispatchEvent(new Event("submit"));
}

/* -----------------------
   Prediction Request
--------------------------*/
document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = new FormData();
    const fileInput = document.getElementById("fileInput");

    if (!fileInput.files[0]) return;

    form.append("file", fileInput.files[0]);
    form.append("user_id", userId);

    const res = await fetch("/predict", { method: "POST", body: form });
    const data = await res.json();

    if (data.error) {
        alert(data.error);
        return;
    }

    // Show results
    document.getElementById("result").style.display = "block";
    document.getElementById("predictionText").innerText = "Prediction: " + data.prediction;
    document.getElementById("adviceText").innerText = "Advice: " + data.advice;
   document.getElementById("audioPlayer").src = "/" + data.audio_file;
   document.getElementById("result").scrollIntoView({ behavior: "smooth" });

    loadHistory();
});
  document.addEventListener("DOMContentLoaded", function() {
    loadHistory();
});

/* -----------------------
   Load History
--------------------------*/
async function loadHistory() {
    const res = await fetch(`/history/${userId}?token=${token}`);
    const data = await res.json();

    const table = document.getElementById("historyTable");
    table.innerHTML = "";

    data.history.forEach(row => {
        table.innerHTML += `
            <tr>
               <td><img src="/uploads/${row[0]}" width="80"></td>
                <td>${row[1]}</td>
                <td>${row[2]}</td>
                <td><audio controls src="/${row[3]}"></audio></td>

                <td>${row[4]}</td>
            </tr>
        `;
    });
}

loadHistory();

/* -----------------------
   Logout
--------------------------*/
function logout() {
    localStorage.clear();
    window.location.href = "/";
}
</script>
<script>
function scrollToHistory() {
    document.getElementById("historySection").scrollIntoView({ behavior: "smooth" });
}
</script>

</body>
</html>
